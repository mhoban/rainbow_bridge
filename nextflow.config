manifest {
    author = 'Mahsa Mousavi-Derazmahalleh'
    name = 'eDNAFlow' 
    homePage = 'http://github.com/mahsa-mousavi/eDNAFlow'
    description = 'Pipeline identifies Zotus using USEARCH unoise3'
    mainScript = 'eDNAFlow.nf'
    version = '1.0.0'
}


resume = true


trace {
  
  fields = 'name,hash,status,exit,realtime,submit,%cpu,%mem'
}


/*
 * Define the pipeline parameters and their default values
 * Each of these parameters can be specified at command line (e.g. --barcode 'x.txt'); if none specified the below will be set as default 
 * We set them like this instead of inside a params {} block because this way their case gets properly translated from cameCase to kebab-case
 */

/* 
 * these options concern where to find sequence reads and barcode file, 
 * which can be done several ways 
*/
params.r1 = "R1"
params.r2 = "R2"
params.fwd = ""
params.rev = ""
params.reads   = "*_{R1,R2}.fastq"
params.barcode = "*_bc.txt"
params.split = false
params.splitBy = 100000
params.baseDir = ""
params.sampleMap = ""

/* various length & quality filtering options */
params.minQuality = "20"
params.minAlignLen = "12"
params.minLen = "50"
params.primerMismatch = "2"
params.minAbundance = "8"

/* blast query options */
params.skipBlast = false
params.blastTask = "blastn"
params.blastDb = System.getenv("BLASTDB") ? System.getenv("BLASTDB") : ""
params.customDb = "NOTHING"
params.customDbName = "NOTHING"
params.maxQueryResults = "10"
params.percentIdentity = "95"
params.evalue = "1e-3"
params.qcov = "100"

/* general script options */
params.vsearch = false
params.denoiser = "usearch32"  
params.publishMode = "symlink" 
params.prefix = "seq"


/* sequence handling & demultiplexing options */
params.paired = false
params.single = false
params.illuminaDemultiplexed = false
params.removeAmbiguousIndices = false
params.demuxOnly = false
params.skipDemux = false
params.demuxedFasta = "*.fasta"
params.fastqc = false
params.demuxedExample = false

/* singularity options */
params.bindDir = ""
params.singularityCache = ""


/* taxonomy assignment / collapse options */
params.assignTaxonomy = false
params.zotuTable = ""
params.blastFile = ""
params.lcaQcov = "100"
params.lcaPid = "97"
params.lcaDiff = "1"
params.filterUncultured = false
params.oldTaxonomy = false

/* insect options */
params.insect = false
params.insectThreshold = 0.8
params.insectOffset = 0
params.insectMinCount  = 5
params.insectPing = 0.98


/* lulu option */
params.skipLulu = false
params.luluMin="84"

/* other stuff */
params.debug = false
params.test = false
params.help = false

/* resource options */
params.maxMemory = Runtime.runtime.maxMemory()
params.maxCpus = Runtime.runtime.availableProcessors()
params.maxTime = 240.h


// Load base.config by default for all pipelines
// move default values for singularity and process there and then enable
includeConfig 'conf/base.config'

// Load test parameters if required
if (params.test) {
  includeConfig 'conf/initialTest.config'
}

// Load profiles from conf/profiles.config
profiles {
  includeConfig 'conf/profiles.config'
}

// Function to ensure that resource requirements don't go beyond
// a maximum limit
def check_max(obj, type) {
  if (type == 'memory') {
    try {
      if (obj.compareTo(get_p(params,'maxMemory') as nextflow.util.MemoryUnit) == 1)
        return get_p(params,'maxMemory') as nextflow.util.MemoryUnit
      else
        return obj
    } catch (all) {
      println "   ### ERROR ###   Max memory '${get_p(params,'maxMemory')}' is not valid! Using default value: $obj"
      return obj
    }
  } else if (type == 'time') {
    try {
      if (obj.compareTo(get_p(params,'maxTime') as nextflow.util.Duration) == 1)
        return get_p(params,'maxTime') as nextflow.util.Duration
      else
        return obj
    } catch (all) {
      println "   ### ERROR ###   Max time '${get_p(params,'maxTime')}' is not valid! Using default value: $obj"
      return obj
    }
  } else if (type == 'cpus') {
    try {
      return Math.min( obj, get_p(params,'maxCpus') as int )
    } catch (all) {
      println "   ### ERROR ###   Max cpus '${get_p(params,'maxCpus')}' is not valid! Using default value: $obj"
      return obj
    }
  }
}

// the parameter case translation hasn't happened yet at this
// point in the config reading/parsing, so we'll have to handle it
// ourselves if we want consisistency. what we'll do is give the
// kebab-case version priority

// convert string to camelCase
def to_camel(s) {
  return s.replaceAll(/(?<small>[a-z])-(?<big>[a-z])/) {
    m,a,b -> a+b.toUpperCase()
  }
}

// convert string to kebab-case
def to_kebab(s) {
  return s.replaceAll(/([a-z])([A-Z])/,'$1-$2').toLowerCase()
}

def get_p(p,k) {
  if (p.containsKey(to_kebab(k))) {
    return p.get(to_kebab(k))
  } else {
    return p.get(k)
  }
}
